<h1>Gerenciamento de Todos os Artigos</h1>
<p>Aqui você pode visualizar, editar e excluir qualquer artigo do sistema.</p>

<div class="card p-3 mb-4">
  <div class="row align-items-center">
    <div class="col-lg-7">
      <strong>Filtrar por status:</strong>
      <%= link_to "Todos", gerenciar_artigos_path, class: "btn btn-sm btn-secondary" %>
      <%= link_to "Pendentes", gerenciar_artigos_path(status: :pendente), class: "btn btn-sm btn-info" %>
      <%= link_to "Aprovados", gerenciar_artigos_path(status: :aprovado), class: "btn btn-sm btn-success" %>
      <%= link_to "Reprovados", gerenciar_artigos_path(status: :reprovado), class: "btn btn-sm btn-danger" %>
    </div>
    <div class="col-lg-5 mt-3 mt-lg-0">
      <%= form_with(url: gerenciar_artigos_path, method: :get, class: "d-flex") do |form| %>
        <%= form.text_field :query, class: "form-control me-2", placeholder: "Buscar por título ou autor...", value: params[:query] %>
        <%= form.submit "Buscar", class: "btn btn-outline-primary" %>
      <% end %>
    </div>
  </div>
</div>

<table class="table table-striped table-hover align-middle">
  <thead>
    <tr>
      <th>Título</th>
      <th>Autor</th>
      <th>Status</th>
      <th class="text-end">Ações</th>
    </tr>
  </thead>
  <tbody>
    <% @articles.each do |article| %>
      <tr>
        <td><%= article.title %></td>
        <td><%= article.user.email %></td>
        <td>
          <span class="badge bg-<%= article.status == 'pendente' ? 'info' : (article.status == 'aprovado' ? 'success' : 'danger') %>">
            <%= article.status.humanize %>
          </span>
        </td>
        <td class="text-end">
  <div class="dropdown">
    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton-<%= article.id %>" data-bs-toggle="dropdown" aria-expanded="false">
      Ações
    </button>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton-<%= article.id %>">
      <li><%= link_to "Ver", article, class: "dropdown-item" %></li>
      <li><hr class="dropdown-divider"></li>
      
      <% if !article.aprovado? %>
        <li><%= button_to "Aprovar", approve_article_path(article), method: :patch, class: "dropdown-item", form: { "data-turbo" => "false" } %></li>
      <% end %>
      
      <% if !article.reprovado? %>
        <li>
          <button type="button" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#rejectModal-<%= article.id %>">
            Reprovar
          </button>
        </li>
      <% end %>
      
      <% if !article.pendente? %>
        <li><%= button_to "Marcar Pendente", set_pending_article_path(article), method: :patch, class: "dropdown-item", form: { "data-turbo" => "false" } %></li>
      <% end %>
      
      <li><hr class="dropdown-divider"></li>
      <li><%= button_to "Excluir", article, method: :delete, data: { turbo_confirm: 'Tem certeza?' }, class: "dropdown-item text-danger", form: { "data-turbo" => "false" } %></li>
    </ul>
  </div>

  <div class="modal fade" id="rejectModal-<%= article.id %>" tabindex="-1" aria-labelledby="rejectModalLabel-<%= article.id %>" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <%= form_with(url: reject_article_path(article), method: :patch, "data-turbo": "false") do |form| %>
          <div class="modal-header">
            <h5 class="modal-title text-start" id="rejectModalLabel-<%= article.id %>">Reprovar Artigo: <%= article.title %></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-start">
            <div class="mb-3">
              <%= form.label :rejection_reason, "Motivo da reprovação (será visível para o aluno):", class: "form-label" %>
              <%= form.text_area :rejection_reason, rows: 4, class: "form-control", required: true %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <%= form.submit "Confirmar Reprovação", class: "btn btn-danger" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</td>
      </tr>
    <% end %>
  </tbody>
</table>

<div class="d-flex justify-content-center mt-4">
  <%== pagy_bootstrap_nav(@pagy) %>
</div>